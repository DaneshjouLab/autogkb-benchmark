# Pipeline
For this package we should be linking together the results from the different experiments to generate one cohesive output per pmcid
that includes found variants, association sentences, and citations. This output should not store the judging results, just the findings generated by each module.

We should be able to control prompts and model choices via a config file and these should also be included in the final output for reproducibility.

Follow conventions established in the experiments we've already done. We shouldn't be reinventing the wheel, let's use the highest performing models and prompts we have from our experiments. Although, to link everything together to run sequentially, we may not be able to just import functions generated under experiments.

All files and intermediate files should be stored in the pipeline folder.

## Implementation

The pipeline is implemented in `pipeline.py` and consists of four stages:

### Stage 1: Variant Extraction (Regex-based)
- Uses regex-based extraction v5 from `experiments/variant_finding/regex_variants/`
- Extracts rsIDs, star alleles, HLA alleles, and SNP notations
- Includes BioC API integration for supplementary material text
- No LLM calls required for this stage

### Stage 2: Sentence Generation (LLM)
- Uses batch processing to generate association sentences for all variants
- Model: gpt-5 with v5 prompt (enhanced phenotype capture)
- Outputs: variant, sentence, explanation for each variant

### Stage 3: Citation Finding (LLM)
- Finds supporting citations (3-5 sentences) for each association
- Model: gpt-4o with v2 prompt (with explanation context)
- Uses full article text to find exact supporting sentences

### Stage 4: Summary Generation (LLM)
- Generates a concise summary of pharmacogenomic findings
- Model: gpt-5 with v1 prompt
- Structured output: Background, Key Findings, Clinical Implications

## Files

- `configs/` - Directory for pipeline configuration files
  - `base_config.yaml` - Base configuration using best-performing models and prompts
- `prompts.yaml` - All LLM prompts used by the pipeline (sentence, citation, summary)
- `pipeline.py` - Main pipeline orchestration script
- `outputs/` - Directory for pipeline output files

## Usage

```bash
# Run pipeline for a single PMCID (results saved to outputs/<config_name>.json)
python pipeline.py --num-pmcids 1

# Run pipeline for all PMCIDs in benchmark
python pipeline.py

# Run with custom config file
python pipeline.py --config configs/my_config.yaml

# Run specific stages only
python pipeline.py --stages variants,sentences

# Process specific PMCIDs
python pipeline.py --pmcids PMC5508045 PMC6435416

# Override existing output file instead of merging
python pipeline.py --num-pmcids 5 --override
```

## Output Behavior

- Output filename is based on the config name (e.g., `base_config.json`)
- By default, new PMCIDs are **merged** into the existing output file
- If a PMCID already exists in the output, it will be **updated** with new results
- Use `--override` flag to replace the entire output file instead of merging

## Output Format

The pipeline outputs a JSON file with the following structure:

```json
{
  "metadata": {
    "timestamp": "2024-01-15T12:00:00",
    "config_name": "base_config",
    "config_description": "Base configuration for the pipeline using previous best performers",
    "num_pmcids": 32,
    "stages_run": ["variants", "sentences", "citations", "summary"],
    "pipeline_config": {
      "variant_extraction": {
        "method": "regex",
        "version": "v5",
        "description": "Regex-based variant extraction with BioC supplement integration"
      },
      "sentence_generation": {
        "model": "gpt-5",
        "prompt_version": "v5"
      },
      "citation_finding": {
        "model": "gpt-4o",
        "prompt_version": "v1"
      },
      "summary_generation": {
        "model": "gpt-5",
        "prompt_version": "v1"
      }
    }
  },
  "results": [
    {
      "pmcid": "PMC5508045",
      "variants": ["rs9923231", "rs1057910", "CYP2C9*3"],
      "variant_extraction_metadata": {
        "has_supplement": true,
        "supplement_variants": ["CYP2C9*3"],
        "total_extracted": 3,
        "from_article": 2,
        "from_supplement": 1
      },
      "associations": [
        {
          "variant_id": "rs9923231",
          "sentence": "Genotypes CT + TT of rs9923231 are associated with decreased dose of warfarin...",
          "explanation": "A study of 1,015 patients found...",
          "citations": [
            "Patients with CT or TT genotypes required significantly lower warfarin doses...",
            "The mean warfarin dose was 3.2 mg/day for CT/TT carriers..."
          ]
        }
      ],
      "summary": "## Background\n..."
    }
  ]
}
```
